// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────────────────────
// ENUMS
// ─────────────────────────────────────────────────────────────

enum UserState {
  CREATED
  ONBOARDING
  ACTIVE
}

enum AgeBand {
  AGE_13_17   @map("13-17")
  AGE_18_24   @map("18-24")
  AGE_25_34   @map("25-34")
  AGE_35_44   @map("35-44")
  AGE_45_PLUS @map("45+")
}

enum OccupationCategory {
  student
  working
  between_jobs
  other
}

enum MessageRole {
  user
  assistant
}

enum MessageStatus {
  RECEIVED
  PROCESSING
  COMPLETED
}

enum MessageSource {
  chat
  retention
}

enum MemoryType {
  FACT
  PREFERENCE
  RELATIONSHIP_EVENT
  EMOTIONAL_PATTERN
}

enum MemoryStatus {
  ACTIVE
  SUPERSEDED
  INVALID
}

enum RelationshipStage {
  STRANGER
  ACQUAINTANCE
  FRIEND
  CLOSE_FRIEND
}

enum RetentionStatus {
  SCHEDULED
  DELIVERED
  ACKNOWLEDGED
  IGNORED
  SKIPPED
}

enum AcknowledgmentType {
  REPLY
  APP_OPEN_NOTIFICATION
  APP_OPEN_INFERRED
}

enum ContentSelectionType {
  FOLLOW_UP
  LIGHT_CONTEXT_NUDGE
  GENERIC_SAFE
}

// ─────────────────────────────────────────────────────────────
// MODELS
// ─────────────────────────────────────────────────────────────

model User {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cognitoSub            String?                 @unique @map("cognito_sub") @db.VarChar(128)
  email                 String?                 @unique @db.VarChar(255)
  passwordHash          String?                 @map("password_hash") @db.VarChar(255)
  emailVerified         Boolean                 @default(false) @map("email_verified")
  state                 UserState               @default(CREATED)
  pushToken             String?                 @map("push_token") @db.VarChar(256)
  createdAt             DateTime                @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime                @updatedAt @map("updated_at") @db.Timestamptz

  onboardingAnswers     UserOnboardingAnswers?
  controls              UserControls?
  aiFriends             AiFriend[]
  conversations         Conversation[]
  messages              Message[]
  memories              Memory[]
  relationships         Relationship[]
  retentionAttempts     RetentionAttempt[]
  retentionBackoff      RetentionBackoff[]
  appOpenEvents         AppOpenEvent[]
  decisionTraces        DecisionTrace[]
  personaAssignmentLogs PersonaAssignmentLog[]

  @@map("users")
}

model UserOnboardingAnswers {
  id                 String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String             @unique @map("user_id") @db.Uuid
  preferredName      String             @map("preferred_name") @db.VarChar(64)
  ageBand            AgeBand            @map("age_band")
  countryOrRegion    String             @map("country_or_region") @db.VarChar(8)
  occupationCategory OccupationCategory @map("occupation_category")
  clientTimezone     String             @map("client_timezone") @db.VarChar(64)
  createdAt          DateTime           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime           @updatedAt @map("updated_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_onboarding_answers")
}

model UserControls {
  id                       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                   String   @unique @map("user_id") @db.Uuid
  proactiveMessagesEnabled Boolean  @default(true) @map("proactive_messages_enabled")
  muteUntil                DateTime? @map("mute_until") @db.Timestamptz
  suppressedTopics         Json     @default("[]") @map("suppressed_topics") @db.JsonB
  suppressedMemoryKeys     Json     @default("[]") @map("suppressed_memory_keys") @db.JsonB
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                DateTime @updatedAt @map("updated_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_controls")
}

model AiFriend {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String    @unique @map("user_id") @db.Uuid
  personaTemplateId  String?   @map("persona_template_id") @db.VarChar(8)
  personaSeed        Int?      @map("persona_seed")
  stableStyleParams  Json?     @map("stable_style_params") @db.JsonB
  tabooSoftBounds    Json      @default("[]") @map("taboo_soft_bounds") @db.JsonB
  assignedAt         DateTime? @map("assigned_at") @db.Timestamptz
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  user                   User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  personaTemplate        PersonaTemplate?       @relation(fields: [personaTemplateId], references: [id])
  conversations          Conversation[]
  messages               Message[]
  memories               Memory[]
  relationships          Relationship[]
  retentionAttempts      RetentionAttempt[]
  retentionBackoff       RetentionBackoff[]
  personaAssignmentLogs  PersonaAssignmentLog[]

  @@map("ai_friends")
}

model PersonaTemplate {
  id                       String   @id @db.VarChar(8)
  coreArchetype            String   @map("core_archetype") @db.VarChar(32)
  speechStyle              Json     @map("speech_style") @db.JsonB
  lexiconBias              Json     @map("lexicon_bias") @db.JsonB
  humorMode                String   @map("humor_mode") @db.VarChar(16)
  emotionalExpressionLevel String   @map("emotional_expression_level") @db.VarChar(16)
  tabooSoftBounds          Json     @map("taboo_soft_bounds") @db.JsonB
  friendEnergy             String   @map("friend_energy") @db.VarChar(16)

  aiFriends AiFriend[]

  @@map("persona_templates")
}

model Conversation {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  aiFriendId String   @map("ai_friend_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiFriend AiFriend  @relation(fields: [aiFriendId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([userId, aiFriendId])
  @@index([userId, aiFriendId])
  @@map("conversations")
}

model Message {
  id                          String        @id @db.Uuid
  conversationId              String        @map("conversation_id") @db.Uuid
  userId                      String        @map("user_id") @db.Uuid
  aiFriendId                  String        @map("ai_friend_id") @db.Uuid
  role                        MessageRole
  content                     String        @db.Text
  contentNorm                 String?       @map("content_norm") @db.Text
  status                      MessageStatus @default(RECEIVED)
  source                      MessageSource @default(chat)
  surfacedMemoryIds           Json          @default("[]") @map("surfaced_memory_ids") @db.JsonB
  extractedMemoryCandidateIds Json          @default("[]") @map("extracted_memory_candidate_ids") @db.JsonB
  openerNorm                  String?       @map("opener_norm") @db.VarChar(256)
  traceId                     String        @map("trace_id") @db.Uuid
  createdAt                   DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                   DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  conversation      Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiFriend          AiFriend           @relation(fields: [aiFriendId], references: [id], onDelete: Cascade)
  decisionTraces    DecisionTrace[]
  retentionAttempts RetentionAttempt[]

  @@index([conversationId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@index([conversationId, role, createdAt(sort: Desc)])
  @@index([surfacedMemoryIds], type: Gin) // GIN index for array containment queries
  @@map("messages")
}

model Memory {
  id               String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String       @map("user_id") @db.Uuid
  aiFriendId       String       @map("ai_friend_id") @db.Uuid
  type             MemoryType
  memoryKey        String       @map("memory_key") @db.VarChar(128)
  memoryValue      String       @map("memory_value") @db.Text
  confidence       Decimal      @db.Decimal(3, 2)
  status           MemoryStatus @default(ACTIVE)
  supersededBy     String?      @map("superseded_by") @db.Uuid
  invalidReason    String?      @map("invalid_reason") @db.VarChar(64)
  sourceMessageIds Json         @default("[]") @map("source_message_ids") @db.JsonB
  embeddingJobId   String?      @map("embedding_job_id") @db.Uuid
  qdrantPointId    String?      @map("qdrant_point_id") @db.Uuid
  createdAt        DateTime     @default(now()) @map("created_at") @db.Timestamptz
  lastConfirmedAt  DateTime     @default(now()) @map("last_confirmed_at") @db.Timestamptz
  updatedAt        DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiFriend          AiFriend @relation(fields: [aiFriendId], references: [id], onDelete: Cascade)
  supersedingMemory Memory?  @relation("MemorySupersession", fields: [supersededBy], references: [id], onDelete: SetNull)
  supersededMemories Memory[] @relation("MemorySupersession")

  @@index([userId, aiFriendId, status])
  @@index([userId, aiFriendId, memoryKey, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("memories")
}

model Relationship {
  id                           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                       String            @map("user_id") @db.Uuid
  aiFriendId                   String            @map("ai_friend_id") @db.Uuid
  relationshipStage            RelationshipStage @default(STRANGER) @map("relationship_stage")
  rapportScore                 Int               @default(0) @map("rapport_score")
  lastInteractionAt            DateTime          @default(now()) @map("last_interaction_at") @db.Timestamptz
  lastStagePromotionAt         DateTime?         @map("last_stage_promotion_at") @db.Timestamptz
  sessionsCount                Int               @default(0) @map("sessions_count")
  lastSessionAt                DateTime?         @map("last_session_at") @db.Timestamptz
  currentSessionShortReplyCount Int              @default(0) @map("current_session_short_reply_count")
  createdAt                    DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                    DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiFriend AiFriend @relation(fields: [aiFriendId], references: [id], onDelete: Cascade)

  @@unique([userId, aiFriendId])
  @@index([relationshipStage])
  @@index([lastInteractionAt])
  @@map("relationships")
}

model RetentionAttempt {
  id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String               @map("user_id") @db.Uuid
  aiFriendId           String               @map("ai_friend_id") @db.Uuid
  messageId            String?              @map("message_id") @db.Uuid
  notificationId       String?              @map("notification_id") @db.Uuid
  status               RetentionStatus      @default(SCHEDULED)
  skipReason           String?              @map("skip_reason") @db.VarChar(32)
  deliveredAt          DateTime?            @map("delivered_at") @db.Timestamptz
  acknowledgedAt       DateTime?            @map("acknowledged_at") @db.Timestamptz
  acknowledgedBy       AcknowledgmentType?  @map("acknowledged_by")
  openerNorm           String?              @map("opener_norm") @db.VarChar(256)
  contentSelectionType ContentSelectionType? @map("content_selection_type")
  createdAt            DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime             @updatedAt @map("updated_at") @db.Timestamptz

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiFriend   AiFriend  @relation(fields: [aiFriendId], references: [id], onDelete: Cascade)
  message    Message?  @relation(fields: [messageId], references: [id], onDelete: SetNull)
  appOpens   AppOpenEvent[]

  @@index([userId, status])
  @@index([userId, deliveredAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("retention_attempts")
}

model RetentionBackoff {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  aiFriendId        String   @map("ai_friend_id") @db.Uuid
  backoffMultiplier Int      @default(1) @map("backoff_multiplier")
  lastIgnoredAt     DateTime? @map("last_ignored_at") @db.Timestamptz
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiFriend AiFriend @relation(fields: [aiFriendId], references: [id], onDelete: Cascade)

  @@unique([userId, aiFriendId])
  @@map("retention_backoff")
}

model AppOpenEvent {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String   @map("user_id") @db.Uuid
  openedNotificationId  String?  @map("opened_notification_id") @db.Uuid
  openedAt              DateTime @default(now()) @map("opened_at") @db.Timestamptz
  attributedRetentionId String?  @map("attributed_retention_id") @db.Uuid
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz

  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  attributedRetention RetentionAttempt? @relation(fields: [attributedRetentionId], references: [id], onDelete: SetNull)

  @@index([userId, openedAt(sort: Desc)])
  @@map("app_open_events")
}

model DecisionTrace {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  traceId                String   @map("trace_id") @db.Uuid
  messageId              String   @map("message_id") @db.Uuid
  userId                 String   @map("user_id") @db.Uuid
  routingDecision        Json     @map("routing_decision") @db.JsonB
  topicMatches           Json     @default("[]") @map("topic_matches") @db.JsonB
  heuristicFlags         Json     @map("heuristic_flags") @db.JsonB
  memoriesLoadedCount    Int      @map("memories_loaded_count")
  memoriesExtractedCount Int      @map("memories_extracted_count")
  relationshipDelta      Int      @map("relationship_delta")
  postprocessorViolations Json    @default("[]") @map("postprocessor_violations") @db.JsonB
  rewriteAttempts        Int      @default(0) @map("rewrite_attempts")
  createdAt              DateTime @default(now()) @map("created_at") @db.Timestamptz

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([traceId])
  @@index([messageId])
  @@index([userId, createdAt(sort: Desc)])
  @@map("decision_traces")
}

model PersonaAssignmentLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  aiFriendId String   @map("ai_friend_id") @db.Uuid
  comboKey   String   @map("combo_key") @db.VarChar(128)
  assignedAt DateTime @default(now()) @map("assigned_at") @db.Timestamptz

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiFriend AiFriend @relation(fields: [aiFriendId], references: [id], onDelete: Cascade)

  @@unique([userId, aiFriendId])
  @@index([comboKey, assignedAt(sort: Desc)])
  @@index([assignedAt])
  @@map("persona_assignment_log")
}
